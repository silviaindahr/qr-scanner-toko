<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Scanner Toko - Sales App</title>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<link rel="manifest" href="manifest.json">

<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { 
  font-family: 'Segoe UI', Arial; 
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}

.container { max-width: 500px; margin: 0 auto; }

.card {
  background: white;
  border-radius: 15px;
  padding: 20px;
  margin-bottom: 15px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

h2 {
  color: white;
  text-align: center;
  margin-bottom: 20px;
  font-size: 28px;
}

.input-group {
  margin-bottom: 15px;
}

label {
  display: block;
  color: #333;
  font-weight: bold;
  margin-bottom: 5px;
  font-size: 14px;
}

input, select {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px;
  transition: border 0.3s;
}

input:focus, select:focus {
  outline: none;
  border-color: #667eea;
}

input:read-only {
  background: #f5f5f5;
  color: #666;
}

button {
  width: 100%;
  padding: 15px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.2s, background 0.3s;
  margin-top: 10px;
}

button:active { transform: scale(0.98); }

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.btn-success {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  color: white;
}

.btn-danger {
  background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
  color: white;
}

.btn-warning {
  background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
  color: white;
}

#reader {
  border-radius: 10px;
  overflow: hidden;
  margin-top: 10px;
}

.hidden { display: none; }

.info-box {
  background: #e3f2fd;
  padding: 15px;
  border-radius: 8px;
  border-left: 4px solid #2196F3;
  margin-bottom: 15px;
}

.info-box h3 {
  color: #1976D2;
  margin-bottom: 8px;
  font-size: 18px;
}

.info-box p {
  color: #555;
  margin: 5px 0;
  font-size: 14px;
}

.preview-box {
  background: #fff3cd;
  padding: 20px;
  border-radius: 10px;
  border: 3px solid #ffc107;
  margin: 20px 0;
}

.preview-box h3 {
  color: #f57c00;
  margin-bottom: 15px;
  text-align: center;
  font-size: 20px;
}

.preview-item {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid #e0e0e0;
}

.preview-item:last-child {
  border-bottom: none;
}

.preview-label {
  font-weight: bold;
  color: #555;
}

.preview-value {
  color: #333;
  font-weight: 600;
}

.preview-value.positive {
  color: #4CAF50;
}

.preview-value.negative {
  color: #F44336;
}

.jumlah-type {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.jumlah-type button {
  flex: 1;
  padding: 10px;
  margin-top: 0;
}

.active-type {
  background: #2196F3 !important;
  color: white !important;
  box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
}

.number-display {
  text-align: center;
  font-size: 48px;
  font-weight: bold;
  color: #667eea;
  padding: 20px;
  background: #f5f5f5;
  border-radius: 10px;
  margin: 10px 0;
}
</style>
</head>

<body>

<div class="container">
  <h2>üì¶ Sales App Toko</h2>

  <!-- STEP 1: SCAN QR -->
  <div class="card" id="step1">
    <div class="input-group">
      <label>üè™ ID Toko</label>
      <input id="tokoId" readonly placeholder="Scan QR untuk mulai">
    </div>
    <button class="btn-primary" onclick="startScan()">üì∑</button>
    <div id="reader" class="hidden"></div>
  </div>

  <!-- STEP 2: INFO TOKO -->
  <div class="card hidden" id="step2">
    <div class="info-box">
      <h3>‚úÖ Toko Ditemukan!</h3>
      <p><strong>ID:</strong> <span id="displayTokoId"></span></p>
      <p><strong>Nama:</strong> <span id="displayNamaToko"></span></p>
    </div>
  </div>

  <!-- STEP 3: FORM TRANSAKSI -->
  <div class="card hidden" id="step3">
    <div class="input-group">
      <label>üìÖ Tanggal</label>
      <input type="date" id="tanggal">
    </div>

    <div class="input-group">
      <label>üî¢ Jumlah Kunjungan</label>
      <input type="number" id="jumlahKunjungan" value="1" min="1">
    </div>

    <div class="input-group">
      <label>üçú Pilih Varian</label>
      <select id="varian">
        <option value="">-- Pilih Varian --</option>
      </select>
    </div>

    <div class="input-group">
      <label>üì¶ Tipe Transaksi</label>
      <div class="jumlah-type">
        <button type="button" class="btn-success active-type" onclick="setType('kirim')">
          ‚ûï KIRIM BARANG
        </button>
        <button type="button" class="btn-danger" onclick="setType('return')">
          ‚ûñ RETURN BARANG
        </button>
      </div>
    </div>

    <div class="input-group">
      <label>üî¢ Jumlah</label>
      <input type="number" id="jumlah" placeholder="Masukkan jumlah" value="0" min="0">
      <div class="number-display" id="jumlahDisplay">0</div>
    </div>

    <div class="input-group">
      <label>üí∞ Status Bayar</label>
      <select id="statusBayar">
        <option value="belum lunas">Belum Lunas</option>
        <option value="lunas">Lunas</option>
      </select>
    </div>

    <button class="btn-warning" onclick="tampilkanPreview()">
      üëÅÔ∏è LIHAT HASIL AKHIR
    </button>
  </div>

  <!-- STEP 4: PREVIEW HASIL -->
  <div class="card hidden" id="step4">
    <div class="preview-box">
      <h3>üìã PREVIEW TRANSAKSI</h3>
      
      <div class="preview-item">
        <span class="preview-label">üìÖ Tanggal:</span>
        <span class="preview-value" id="prevTanggal"></span>
      </div>
      
      <div class="preview-item">
        <span class="preview-label">üè™ Nama Toko:</span>
        <span class="preview-value" id="prevNamaToko"></span>
      </div>
      
      <div class="preview-item">
        <span class="preview-label">üÜî ID Toko:</span>
        <span class="preview-value" id="prevTokoId"></span>
      </div>
      
      <div class="preview-item">
        <span class="preview-label">üî¢ Kunjungan:</span>
        <span class="preview-value" id="prevKunjungan"></span>
      </div>
      
      <div class="preview-item">
        <span class="preview-label">üçú Varian:</span>
        <span class="preview-value" id="prevVarian"></span>
      </div>
      
      <div class="preview-item">
        <span class="preview-label">üì¶ Tipe:</span>
        <span class="preview-value" id="prevTipe"></span>
      </div>
      
      <div class="preview-item">
        <span class="preview-label">üìä Jumlah:</span>
        <span class="preview-value" id="prevJumlah"></span>
      </div>
      
      <div class="preview-item">
        <span class="preview-label">üí∞ Status Bayar:</span>
        <span class="preview-value" id="prevStatus"></span>
      </div>
      
      <div class="preview-item" style="border-top: 2px solid #ffc107; padding-top: 15px; margin-top: 10px;">
        <span class="preview-label" style="font-size: 18px;">üíµ Total Harga:</span>
        <span class="preview-value" id="prevHarga" style="font-size: 20px; color: #4CAF50;"></span>
      </div>
    </div>

    <button class="btn-success" onclick="kirimTransaksi()">
      ‚úÖ KIRIM KE SPREADSHEET
    </button>

    <button class="btn-primary" onclick="kembaliEdit()" style="background: #999;">
      ‚úèÔ∏è EDIT LAGI
    </button>
  </div>

  <!-- STEP 5: SUKSES -->
  <div class="card hidden" id="step5">
    <div class="info-box" style="background: #c8e6c9; border-left-color: #4CAF50;">
      <h3 style="color: #2E7D32;">‚úÖ TRANSAKSI BERHASIL!</h3>
      <p><strong>Nomor Baris:</strong> <span id="successRow"></span></p>
      <p><strong>Total Harga:</strong> Rp <span id="successHarga"></span></p>
      <p style="margin-top: 10px; font-style: italic;">Data sudah masuk ke spreadsheet!</p>
    </div>

    <button class="btn-primary" onclick="transaksiLagi()">
      üîÑ TRANSAKSI BARU
    </button>

    <button class="btn-primary" onclick="scanLagi()" style="background: #999;">
      üì∑ SCAN TOKO LAIN
    </button>
  </div>

</div>

<script>
// ============================================
// KONFIGURASI - GANTI URL DEPLOY
// ============================================
const URL_API = "https://script.google.com/macros/s/AKfycbxfkKaPyY50Is_ICGHM-pD_DLnfugLJF3hQqf75yBO1-f_Xxka_JsNh00fr6TkJx_Tu9g/exec";

let tokoData = null;
let transaksiType = 'kirim';
let html5QrCode = null;
let previewData = null;

// ============================================
// SET TANGGAL HARI INI
// ============================================
window.onload = function() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('tanggal').value = today;
  
  // Update display jumlah saat input berubah
  document.getElementById('jumlah').addEventListener('input', function() {
    updateJumlahDisplay();
  });
  
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
}

// ============================================
// UPDATE DISPLAY JUMLAH
// ============================================
function updateJumlahDisplay() {
  const jumlah = parseInt(document.getElementById('jumlah').value) || 0;
  const display = document.getElementById('jumlahDisplay');
  
  if (transaksiType === 'kirim') {
    display.textContent = '+' + jumlah;
    display.style.color = '#4CAF50';
  } else {
    display.textContent = '-' + jumlah;
    display.style.color = '#F44336';
  }
}

// ============================================
// MULAI SCAN QR
// ============================================
function startScan() {
  document.getElementById('reader').classList.remove('hidden');
  
  html5QrCode = new Html5Qrcode("reader");
  
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      document.getElementById("tokoId").value = decodedText;
      html5QrCode.stop();
      document.getElementById('reader').classList.add('hidden');
      ambilDataToko(decodedText);
    }
  ).catch(err => {
    alert("Error kamera: " + err);
  });
}

// ============================================
// AMBIL DATA TOKO
// ============================================
function ambilDataToko(tokoId) {
  document.getElementById('step1').style.opacity = '0.5';
  
  fetch(URL_API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "getTokoInfo",
      tokoId: tokoId
    })
  })
  .then(res => res.json())
  .then(result => {
    document.getElementById('step1').style.opacity = '1';
    
    if (result.success) {
      tokoData = result.data;
      
      document.getElementById('displayTokoId').textContent = tokoData.tokoId;
      document.getElementById('displayNamaToko').textContent = tokoData.namaToko;
      document.getElementById('step2').classList.remove('hidden');
      
      const selectVarian = document.getElementById('varian');
      selectVarian.innerHTML = '<option value="">-- Pilih Varian --</option>';
      tokoData.varian.forEach(v => {
        selectVarian.innerHTML += `<option value="${v}">${v}</option>`;
      });
      
      document.getElementById('step3').classList.remove('hidden');
      
    } else {
      alert(result.message);
    }
  })
  .catch(err => {
    document.getElementById('step1').style.opacity = '1';
    alert("Error: " + err);
  });
}

// ============================================
// SET TIPE TRANSAKSI
// ============================================
function setType(type) {
  transaksiType = type;
  
  const buttons = document.querySelectorAll('.jumlah-type button');
  buttons.forEach(btn => btn.classList.remove('active-type'));
  
  if (type === 'kirim') {
    buttons[0].classList.add('active-type');
  } else {
    buttons[1].classList.add('active-type');
  }
  
  updateJumlahDisplay();
}

// ============================================
// HITUNG HARGA
// ============================================
function hitungHarga(varian, jumlah) {
  const hargaPerItem = {
    "terasi udang": 14000
  };
  
  const harga = hargaPerItem[varian] || 14000;
  return harga * Math.abs(jumlah);
}

// ============================================
// TAMPILKAN PREVIEW
// ============================================
function tampilkanPreview() {
  const tanggal = document.getElementById('tanggal').value;
  const varian = document.getElementById('varian').value;
  const jumlah = parseInt(document.getElementById('jumlah').value);
  const jumlahKunjungan = parseInt(document.getElementById('jumlahKunjungan').value);
  const statusBayar = document.getElementById('statusBayar').value;
  
  if (!tanggal || !varian || jumlah === 0) {
    alert("‚ùå Harap isi semua field!");
    return;
  }
  
  const jumlahFinal = transaksiType === 'kirim' ? jumlah : -jumlah;
  const totalHarga = hitungHarga(varian, jumlahFinal);
  
  previewData = {
    tanggal: tanggal,
    namaToko: tokoData.namaToko,
    tokoId: tokoData.tokoId,
    jumlahKunjungan: jumlahKunjungan,
    varian: varian,
    jumlah: jumlahFinal,
    statusBayar: statusBayar,
    totalHarga: totalHarga
  };
  
  document.getElementById('prevTanggal').textContent = tanggal;
  document.getElementById('prevNamaToko').textContent = tokoData.namaToko;
  document.getElementById('prevTokoId').textContent = tokoData.tokoId;
  document.getElementById('prevKunjungan').textContent = jumlahKunjungan;
  document.getElementById('prevVarian').textContent = varian;
  document.getElementById('prevTipe').textContent = transaksiType === 'kirim' ? '‚ûï KIRIM BARANG' : '‚ûñ RETURN BARANG';
  
  const jumlahEl = document.getElementById('prevJumlah');
  jumlahEl.textContent = jumlahFinal;
  jumlahEl.className = 'preview-value ' + (jumlahFinal > 0 ? 'positive' : 'negative');
  
  document.getElementById('prevStatus').textContent = statusBayar;
  document.getElementById('prevHarga').textContent = 'Rp ' + totalHarga.toLocaleString('id-ID');
  
  document.getElementById('step4').classList.remove('hidden');
  
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

// ============================================
// KEMBALI EDIT
// ============================================
function kembaliEdit() {
  document.getElementById('step4').classList.add('hidden');
  window.scrollTo({ top: document.getElementById('step3').offsetTop - 20, behavior: 'smooth' });
}

// ============================================
// KIRIM TRANSAKSI
// ============================================
function kirimTransaksi() {
  const btn = document.querySelector('#step4 .btn-success');
  btn.textContent = '‚è≥ Mengirim...';
  btn.disabled = true;
  
  fetch(URL_API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "tambahTransaksi",
      ...previewData
    })
  })
  .then(res => res.json())
  .then(result => {
    btn.textContent = '‚úÖ KIRIM KE SPREADSHEET';
    btn.disabled = false;
    
    if (result.success) {
      document.getElementById('successRow').textContent = result.data.rowNumber;
      document.getElementById('successHarga').textContent = result.data.totalHarga.toLocaleString('id-ID');
      
      document.getElementById('step3').classList.add('hidden');
      document.getElementById('step4').classList.add('hidden');
      document.getElementById('step5').classList.remove('hidden');
      
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      
    } else {
      alert("‚ùå " + result.message);
    }
  })
  .catch(err => {
    btn.textContent = '‚úÖ KIRIM KE SPREADSHEET';
    btn.disabled = false;
    alert("Error: " + err);
  });
}

// ============================================
// TRANSAKSI LAGI (TOKO SAMA)
// ============================================
function transaksiLagi() {
  document.getElementById('jumlah').value = 0;
  document.getElementById('varian').value = '';
  document.getElementById('jumlahKunjungan').value = 1;
  updateJumlahDisplay();
  
  document.getElementById('step5').classList.add('hidden');
  document.getElementById('step3').classList.remove('hidden');
  
  window.scrollTo({ top: document.getElementById('step3').offsetTop - 20, behavior: 'smooth' });
}

// ============================================
// SCAN TOKO LAIN
// ============================================
function scanLagi() {
  document.getElementById('tokoId').value = '';
  document.getElementById('step2').classList.add('hidden');
  document.getElementById('step3').classList.add('hidden');
  document.getElementById('step4').classList.add('hidden');
  document.getElementById('step5').classList.add('hidden');
  tokoData = null;
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>

</body>
</html>
